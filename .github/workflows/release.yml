name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.0.1)'
        required: true
        default: 'v0.0.1'

permissions:
  contents: write
  packages: write

env:
  PROJECT_NAME: objectsync

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: windows
            goarch: amd64
            suffix: .exe
          - goos: windows
            goarch: arm64
            suffix: .exe
          - goos: linux
            goarch: amd64
            suffix: ""
          - goos: linux
            goarch: arm64
            suffix: ""
          - goos: darwin
            goarch: amd64
            suffix: ""
          - goos: darwin
            goarch: arm64
            suffix: ""

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®GoçŽ¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: '1.24.1'

    - name: èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TAG="${{ github.event.inputs.tag }}"
        else
          TAG=${GITHUB_REF#refs/tags/}
        fi
        VERSION=${TAG#v}
        BUILD_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        GIT_COMMIT=$(git rev-parse --short HEAD)
        
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
        echo "git_commit=$GIT_COMMIT" >> $GITHUB_OUTPUT

    - name: ä¸‹è½½ä¾èµ–
      run: go mod download

    - name: æž„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        LDFLAGS="-s -w -X 'main.Version=${{ steps.version.outputs.version }}' -X 'main.BuildTime=${{ steps.version.outputs.build_time }}' -X 'main.GitCommit=${{ steps.version.outputs.git_commit }}'"
        BINARY_NAME="${PROJECT_NAME}-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.suffix }}"
        
        go build -ldflags="$LDFLAGS" -o "$BINARY_NAME" cmd/main.go
        
        echo "BINARY_NAME=$BINARY_NAME" >> $GITHUB_ENV

    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.BINARY_NAME }}
        path: ${{ env.BINARY_NAME }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TAG="${{ github.event.inputs.tag }}"
        else
          TAG=${GITHUB_REF#refs/tags/}
        fi
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: è°ƒè¯•artifactç»“æž„
      run: |
        echo "=== Artifact ç›®å½•ç»“æž„ ==="
        find artifacts -type f -ls || echo "æ²¡æœ‰æ‰¾åˆ°artifactsç›®å½•"
        echo ""
        echo "=== å½“å‰ç›®å½•å†…å®¹ ==="
        ls -la
        
    - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release
        
        echo "=== å¼€å§‹å¤„ç†artifact ==="
        
        # ä¸ºæ¯ä¸ªå¹³å°åˆ›å»ºåŽ‹ç¼©åŒ…
        for artifact_dir in artifacts/*/; do
          if [ -d "$artifact_dir" ]; then
            artifact_name=$(basename "$artifact_dir")
            echo "å¤„ç† artifact: $artifact_name"
            
            # æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶
            binary_file=$(find "$artifact_dir" -type f \( -name "*.exe" -o ! -name ".*" \) | head -1)
            echo "æ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶: $binary_file"
            
            if [ -f "$binary_file" ]; then
              # åˆ›å»ºä¸´æ—¶ç›®å½•
              temp_dir="temp_$artifact_name"
              mkdir -p "$temp_dir"
              
              # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
              if [[ "$artifact_name" == *"windows"* ]]; then
                cp "$binary_file" "$temp_dir/${PROJECT_NAME}.exe"
                echo "å¤åˆ¶WindowsäºŒè¿›åˆ¶æ–‡ä»¶åˆ°: $temp_dir/${PROJECT_NAME}.exe"
              else
                cp "$binary_file" "$temp_dir/${PROJECT_NAME}"
                chmod +x "$temp_dir/${PROJECT_NAME}"
                echo "å¤åˆ¶Linux/macOSäºŒè¿›åˆ¶æ–‡ä»¶åˆ°: $temp_dir/${PROJECT_NAME}"
              fi
              
              # å¤åˆ¶æ–‡æ¡£æ–‡ä»¶
              [ -f README.md ] && cp README.md "$temp_dir/" && echo "å¤åˆ¶ README.md"
              [ -f LICENSE ] && cp LICENSE "$temp_dir/" && echo "å¤åˆ¶ LICENSE"
              
              # å¤åˆ¶è„šæœ¬æ–‡ä»¶
              if [ -d scripts ]; then
                mkdir -p "$temp_dir/scripts"
                if [[ "$artifact_name" == *"windows"* ]]; then
                  find scripts -name "*.bat" -exec cp {} "$temp_dir/scripts/" \; && echo "å¤åˆ¶Windowsè„šæœ¬"
                else
                  find scripts -name "*.sh" -exec cp {} "$temp_dir/scripts/" \;
                  find "$temp_dir/scripts" -name "*.sh" -exec chmod +x {} \;
                  echo "å¤åˆ¶Linux/macOSè„šæœ¬"
                fi
              fi
              
              # åˆ›å»ºåŽ‹ç¼©åŒ…
              release_file=""
              if [[ "$artifact_name" == *"windows"* ]]; then
                release_file="release/${PROJECT_NAME}-${{ steps.version.outputs.tag }}-${artifact_name#${PROJECT_NAME}-}.zip"
                (cd "$temp_dir" && zip -r "../$release_file" .)
              else
                release_file="release/${PROJECT_NAME}-${{ steps.version.outputs.tag }}-${artifact_name#${PROJECT_NAME}-}.tar.gz"
                tar -czf "$release_file" -C "$temp_dir" .
              fi
              
              echo "åˆ›å»ºå‘å¸ƒåŒ…: $release_file"
              
              # æ¸…ç†ä¸´æ—¶ç›®å½•
              rm -rf "$temp_dir"
            else
              echo "è­¦å‘Š: åœ¨ $artifact_dir ä¸­æœªæ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶"
            fi
          fi
        done
        
        echo "=== å‘å¸ƒæ–‡ä»¶åˆ—è¡¨ ==="
        ls -la release/ || echo "releaseç›®å½•ä¸ºç©º"

    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
      run: |
        echo "ObjectSync ${{ steps.version.outputs.tag }} å‘å¸ƒ" > release_body.md
        echo "" >> release_body.md
        echo "è¿™æ˜¯ ObjectSync å¯¹è±¡å­˜å‚¨ä¸‹è½½å·¥å…·çš„ ${{ steps.version.outputs.tag }} ç‰ˆæœ¬ã€‚" >> release_body.md
        echo "" >> release_body.md
        echo "## ðŸ“¦ å‘å¸ƒæ–‡ä»¶" >> release_body.md
        echo "" >> release_body.md
        
        if [ -d release ] && [ "$(ls -A release)" ]; then
          for file in release/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(ls -lh "$file" | awk '{print $5}')
              echo "- \`$filename\` ($filesize)" >> release_body.md
            fi
          done
        else
          echo "- å‘å¸ƒæ–‡ä»¶ç”Ÿæˆä¸­..." >> release_body.md
        fi
        
        echo "" >> release_body.md
        echo "## ðŸš€ å¿«é€Ÿå¼€å§‹" >> release_body.md
        echo "" >> release_body.md
        echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…" >> release_body.md
        echo "2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•" >> release_body.md
        echo "3. è¿è¡Œ \`objectsync\` å¯åŠ¨äº¤äº’å¼èœå•" >> release_body.md
        echo "4. æŒ‰ç…§æç¤ºè¿›è¡Œé…ç½®å’Œä½¿ç”¨" >> release_body.md
        
        echo "" >> release_body.md
        echo "### ðŸ“‹ æ”¯æŒçš„å¹³å°" >> release_body.md
        echo "" >> release_body.md
        echo "- Windows (AMD64/ARM64)" >> release_body.md
        echo "- Linux (AMD64/ARM64)" >> release_body.md
        echo "- macOS (AMD64/ARM64)" >> release_body.md
        
        echo "" >> release_body.md
        echo "æ„Ÿè°¢ä½¿ç”¨ ObjectSyncï¼" >> release_body.md

    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: ObjectSync ${{ steps.version.outputs.tag }}
        body_path: release_body.md
        files: |
          release/*.zip
          release/*.tar.gz
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 